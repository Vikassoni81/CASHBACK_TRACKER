<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CardMaster Cloud</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #050505;
            --surface: #141414;
            --accent: #e40046; /* Dynamic */
            --text: #ffffff;
            --text-dim: #888888;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 0; 
            min-height: 100vh; transition: background 0.5s ease; padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.4s ease;
        }
        #loginScreen.hidden { opacity: 0; pointer-events: none; }

        .login-content { text-align: center; display: none; animation: fadeIn 0.5s; }
        
        .loader {
            width: 40px; height: 40px; border: 4px solid #333; 
            border-top: 4px solid var(--accent); border-radius: 50%; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .google-btn {
            background: white; color: #333; border: none; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; font-size: 1rem;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255,255,255,0.2); transition: transform 0.2s;
            margin: 0 auto 15px auto;
        }
        .google-btn:active { transform: scale(0.95); }
        
        .guest-link { color: #666; text-decoration: underline; font-size: 0.9rem; cursor: pointer; }

        /* --- AMBIENT GLOW --- */
        .ambient-glow {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150vmax; height: 150vmax;
            background: radial-gradient(circle closest-side, var(--accent) 0%, transparent 60%);
            opacity: 0.15; filter: blur(120px); z-index: -2; pointer-events: none;
            transition: background 0.8s ease;
        }

        /* --- THEME LINE --- */
        .theme-line {
            width: 100px; margin: 10px auto 20px auto; height: 3px;
            background: var(--accent); box-shadow: 0 0 15px var(--accent);
            border-radius: 10px; transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        /* --- HEADER --- */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; position: relative; height: 60px; }
        .menu-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; z-index: 2; }
        .app-name { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 800; font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0.9; white-space: nowrap; }
        .cycle-badge { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; color: #bbb; background: rgba(255,255,255,0.08); padding: 5px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); z-index: 2; }

        .total-display { text-align: center; margin-bottom: 15px; position: relative; z-index: 2; }
        .total-display h1 { margin: 0; font-size: 2.8rem; font-weight: 800; text-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .total-display p { margin: 0; font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

        /* --- CARDS --- */
        .swiper-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding: 10px 10vw; gap: 20px; height: 240px; scrollbar-width: none; align-items: center; z-index: 5; }
        .swiper-container::-webkit-scrollbar { display: none; }

        .credit-card {
            flex: 0 0 80vw; height: 200px; border-radius: 24px; scroll-snap-align: center;
            position: relative; padding: 25px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); 
            transition: transform 0.3s ease, opacity 0.3s, border 0.3s; cursor: pointer; opacity: 0.5; transform: scale(0.92);
            background: #222; overflow: hidden; z-index: 1; display: none; /* Hidden until filtered */
        }
        .credit-card.visible { display: flex; }
        .credit-card.active-card { opacity: 1; transform: scale(1); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }

        .card-bg-shine { position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, transparent 40%); pointer-events: none; }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 2; }
        .chip { width: 40px; height: 28px; background: linear-gradient(135deg, #ffd700, #b8860b); border-radius: 5px; opacity: 0.9; }
        .card-logo { font-weight: 800; font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8); text-align: right; }
        .card-val { position: relative; z-index: 2; }
        .card-val h2 { font-size: 2.2rem; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .card-val span { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

        .theme-airtel { background: linear-gradient(135deg, #1a1a1a 0%, #500714 100%); }
        .theme-sbi { background: linear-gradient(135deg, #0f172a 0%, #172554 100%); }
        .theme-amazon { background: linear-gradient(135deg, #1c1917 0%, #78350f 100%); }
        .theme-tata { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); border: 1px solid #a855f7 !important; }
        .theme-icici { background: linear-gradient(135deg, #2c0b0e, #991b1b); }
        .theme-simply { background: linear-gradient(135deg, #064e3b, #1a1a1a); }
        .theme-phonepe { background: linear-gradient(135deg, #240b36 0%, #000000 100%); border: 1px solid #673ab7 !important; }

        /* --- CONTENT --- */
        .content-area { padding: 0 20px; margin-top: 10px; animation: fadeIn 0.5s ease; position: relative; z-index: 2; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); margin: 30px 0 10px 0; font-weight: 700; letter-spacing: 1px; }

        .bar-item { margin-bottom: 15px; }
        .bar-head { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px; }
        .track { width: 100%; height: 6px; background: rgba(255,255,255,0.08); border-radius: 3px; overflow: hidden; }
        .fill { height: 100%; transition: width 0.5s ease; background: var(--accent); border-radius: 3px; box-shadow: 0 0 10px var(--accent); }
        
        .waiver-box { background: rgba(255,215,0,0.05); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,215,0,0.2); margin-top: 30px; }
        .waiver-head { color: #ffd700; font-size: 0.85rem; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 8px; }
        .waiver-track { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .waiver-fill { height: 100%; background: linear-gradient(90deg, #ffd700, #b8860b); width: 0%; }

        .trans-list { background: var(--surface); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; }
        .trans-item { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;}
        .trans-item:last-child { border-bottom: none; }
        .t-left h4 { margin: 0; font-size: 0.95rem; font-weight: 500; }
        .t-cat { font-size: 0.75rem; color: var(--text-dim); margin-top: 3px; }
        .t-right { text-align: right; }
        .t-cb { color: var(--accent); font-weight: 700; font-size: 0.9rem; }
        .del-btn { color: #555; font-size: 0.7rem; margin-top: 5px; cursor: pointer; }

        /* --- UI ELEMENTS --- */
        #toast { visibility: hidden; min-width: 250px; background-color: #111; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 300; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 0.9rem; box-shadow: 0 5px 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; justify-content: center; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--text); color: black; border-radius: 50%; border: none; font-size: 30px; box-shadow: 0 5px 20px rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; transition: 0.2s; }
        .fab:active { transform: scale(0.9); }

        /* SIDEBAR */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 90; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(5px); }
        .overlay.active { opacity: 1; visibility: visible; }
        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-width)); width: var(--sidebar-width); height: 100%; background: #111; z-index: 100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: var(--accent); transition: background 0.3s; }
        .user-name { font-size: 1.4rem; font-weight: 800; margin-bottom: 5px; }
        .nav-links { padding: 20px 0; }
        .nav-item { padding: 15px 25px; display: flex; align-items: center; gap: 15px; font-size: 1rem; cursor: pointer; color: #ccc; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a1a; width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 25px; border-top: 1px solid rgba(255,255,255,0.1); animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto;}
        
        /* MANAGE CARDS LIST */
        .card-checkbox-list { display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; }
        .card-option { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; }
        .card-option label { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; width: 100%; }
        .card-option input[type="checkbox"] { accent-color: var(--accent); transform: scale(1.2); }

        /* USER SETUP POPUP */
        #userModal { align-items: center !important; justify-content: center !important; z-index: 3000; }
        .mobile-box { background: #1a1a1a; padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--accent); box-shadow: 0 0 40px rgba(0,0,0,0.8); animation: fadeIn 0.5s; }

        .form-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 14px; border-radius: 12px; font-size: 1rem; margin-bottom: 15px; outline: none; }
        .btn-action { width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; margin-top: 5px; }
        .presets-row { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; scrollbar-width: none; }
        .preset-chip { background: #222; border: 1px solid #333; color: #ccc; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; cursor: pointer; }

        .history-stats { display: flex; gap: 10px; margin: 20px 0; }
        .stat-box { flex: 1; background: #222; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        .stat-val { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }

        @keyframes slideUp { from {transform:translateY(100%);} to {transform:translateY(0);} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div id="loginScreen">
        <div id="authLoader" class="loader"></div>
        <div id="authButtons" class="login-content">
            <h1 style="font-size:4rem; margin-bottom:10px;">üí≥</h1>
            <h2 style="margin-bottom:10px;">CardMaster</h2>
            <p style="color:#888; margin-bottom:30px; font-size:0.9rem;">Secure Cloud Sync</p>
            <button class="google-btn" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Sign in with Google
            </button>
            <div class="guest-link" onclick="continueAsGuest()">Continue as Guest</div>
        </div>
    </div>

    <div class="modal" id="userModal" style="z-index: 3000; background: rgba(0,0,0,0.95);">
        <div class="mobile-box">
            <h3 style="margin-top:0;">Setup Profile</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Link details for secure sync.</p>
            <input type="text" id="setupName" class="form-input" placeholder="Your Name" style="text-align:center; font-size:1.1rem;">
            <input type="tel" id="setupMobile" class="form-input" placeholder="Mobile Number" maxlength="10" style="text-align:center; letter-spacing:2px; font-size:1.2rem;">
            <button class="btn-action" style="background:var(--accent); color:white;" onclick="saveUserDetails()">Start Tracking</button>
        </div>
    </div>

    <div class="ambient-glow"></div>
    <div id="toast"><span>‚úÖ</span> <span id="toastMsg">Notification</span></div>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="user-name" id="sidebarUser">Guest</div>
            <div style="font-size:0.8rem; opacity:0.8; text-decoration:underline; cursor:pointer;" onclick="logout()">Logout</div>
        </div>
        <div class="nav-links">
            <div class="nav-item" onclick="toggleMenu()"><span class="nav-icon">üè†</span> Dashboard</div>
            <div class="nav-item" onclick="openManageCards()"><span class="nav-icon">üí≥</span> Manage Cards</div>
            <div class="nav-item" onclick="openHistoryModal()"><span class="nav-icon">üìú</span> History & Statements</div>
            <div class="nav-item" onclick="openCycleSettings()"><span class="nav-icon">üóì</span> Change Statement Cycle</div>
            <div class="nav-item" onclick="openSettings()"><span class="nav-icon">‚öôÔ∏è</span> Data Settings</div>
        </div>
    </div>

    <header>
        <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <div class="app-name">CardMaster</div>
        <div class="cycle-badge" id="headerCycle">...</div> 
    </header>

    <div class="total-display">
        <p>Total Cashback Earned</p>
        <h1 id="grandTotal">‚Çπ0</h1>
    </div>

    <div class="swiper-container" id="cardSwiper"></div>

    <div id="emptyState" style="text-align:center; display:none; padding:20px; opacity:0.5;">
        <p>No cards selected.</p>
        <button class="btn-action" style="background:#333; width:auto;" onclick="openManageCards()">Add Cards</button>
    </div>

    <div class="content-area">
        <div class="theme-line"></div>
        <div class="section-title">Category Limits</div>
        <div id="limit-container"></div>
        <div class="section-title">Transactions</div>
        <div id="trans-container" class="trans-list"></div>
        <div class="section-title">Fee Waiver</div>
        <div class="waiver-box">
            <div class="waiver-head"><span>Annual Spend</span><span id="waiverStatus">‚Çπ0 / ‚Çπ2L</span></div>
            <div class="waiver-track"><div class="waiver-fill" id="waiverFill"></div></div>
            <div style="font-size:0.7rem; color:#888; margin-top:5px;" id="waiverMsg">Keep spending to waive fee</div>
        </div>
        <div style="height: 50px;"></div>
    </div>

    <button class="fab" onclick="checkAuthAndOpen()">+</button>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3 style="margin-top:0">Add Transaction</h3>
            <div class="presets-row" id="presetsArea"></div>
            <input type="date" id="tDate" class="form-input">
            <select id="tCategory" class="form-input"></select>
            <input type="text" id="tDesc" class="form-input" placeholder="Merchant Name">
            <input type="number" id="tAmount" class="form-input" placeholder="Amount (‚Çπ)">
            <div style="display:flex; gap:10px">
                <button class="btn-action" style="background:#222; color:#fff; flex:1" onclick="savePreset()">Save Preset</button>
                <button class="btn-action" style="background:white; color:black; flex:2" onclick="saveTrans()">Add Now</button>
            </div>
            <button class="btn-action" style="background:transparent; color:#555;" onclick="document.getElementById('addModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="manageCardsModal">
        <div class="modal-content">
            <h3 style="margin-top:0">Select Your Cards</h3>
            <div class="card-checkbox-list" id="manageCardsList"></div>
            <button class="btn-action" style="background:white; color:black; margin-top:20px;" onclick="saveVisibleCards()">Save Selection</button>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-height: 85vh;">
            <h3 style="margin-top:0">Statement History</h3>
            <label style="font-size:0.8rem; color:#888;">Select Card</label>
            <select id="hCardSelect" class="form-input" onchange="updateHistoryCycles()"></select>
            <label style="font-size:0.8rem; color:#888;">Billing Cycle</label>
            <select id="hCycleSelect" class="form-input" onchange="renderHistoryList()"></select>
            <div class="history-stats">
                <div class="stat-box"><div class="stat-label">Total Spent</div><div class="stat-val" id="hTotalSpend">‚Çπ0</div></div>
                <div class="stat-box"><div class="stat-label">Cashback</div><div class="stat-val" id="hTotalCb" style="color: var(--accent)">‚Çπ0</div></div>
            </div>
            <div id="hListContainer" class="trans-list" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn-action" style="background:#222; color:#fff;" onclick="document.getElementById('historyModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <div class="modal" id="cycleModal">
        <div class="modal-content">
            <h3 style="margin-top:0">Cycle & Anniversary</h3>
            <label style="font-size:0.8rem; color:#888;">Select Card</label>
            <select id="cCardSelect" class="form-input" onchange="loadCardSettings()"></select>
            <label style="font-size:0.8rem; color:#888;">Billing Start Day (e.g. 12)</label>
            <input type="number" id="cStartDay" class="form-input" placeholder="12">
            <label style="font-size:0.8rem; color:#888;">Card Anniversary Date</label>
            <input type="date" id="cAnniversary" class="form-input">
            <button class="btn-action" style="background:white; color:black;" onclick="saveCardSettings()">Save Changes</button>
            <button class="btn-action" style="background:transparent; color:#555;" onclick="document.getElementById('cycleModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>Data Settings</h3>
            <p style="color:#666; font-size:0.9rem;">Manage your data securely.</p>
            <button class="btn-action" style="background:#222; color:white; margin-bottom:10px;" onclick="exportJSON()">üì• Backup to File</button>
            <button class="btn-action" style="background:#222; color:white; margin-bottom:10px;" onclick="document.getElementById('importFile').click()">üì§ Restore from File</button>
            <input type="file" id="importFile" style="display:none" onchange="importJSON(this)">
            <button class="btn-action" style="background:#222; color:#ef4444;" onclick="clearAll()">‚ö† Reset Everything</button>
            <button class="btn-action" style="background:transparent; color:#555;" onclick="document.getElementById('settingsModal').classList.remove('active')">Close</button>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDNUHsEcwMPl5bLaZOSqNYvgn8cWMIsmVk",
        authDomain: "cardmaster-a2e4a.firebaseapp.com",
        projectId: "cardmaster-a2e4a",
        storageBucket: "cardmaster-a2e4a.firebasestorage.app",
        messagingSenderId: "418789544330",
        appId: "1:418789544330:web:9c500a88ba9e057b93f873"
    };

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // --- CONFIG ---
    const DEFAULT_CARDS = {
        'airtel': { name: "Airtel Axis", color: "#e40046", theme: "theme-airtel", billingDay: 12, waiverLimit: 200000, anniversary: "2024-01-01", rules: [{ id: 'airtel', label: 'Airtel (25%)', rate: 0.25, cap: 250 }, { id: 'utility', label: 'Utility (10%)', rate: 0.10, cap: 250 }, { id: 'eats', label: 'Eats (10%)', rate: 0.10, cap: 500 }, { id: 'other', label: 'Other (1%)', rate: 0.01, cap: 999999999 }] },
        'sbi': { name: "SBI Cashback", color: "#3b82f6", theme: "theme-sbi", billingDay: 1, waiverLimit: 200000, anniversary: "2024-01-01", roundDown100: false, rules: [{ id: 'online', label: 'Online (5%)', rate: 0.05, cap: 5000 }, { id: 'offline', label: 'Offline (1%)', rate: 0.01, cap: 999999999 }] },
        'amazon': { name: "Amazon Pay", color: "#f59e0b", theme: "theme-amazon", billingDay: 1, waiverLimit: 0, anniversary: "2024-01-01", roundDown100: false, rules: [{ id: 'prime', label: 'Prime (5%)', rate: 0.05, cap: 999999999 }, { id: 'nonprime', label: 'Non-Prime (3%)', rate: 0.03, cap: 999999999 }, { id: 'other', label: 'Other (1%)', rate: 0.01, cap: 999999999 }] },
        'tata': { name: "Tata Neu Plus", color: "#8b5cf6", theme: "theme-tata", billingDay: 1, waiverLimit: 100000, anniversary: "2024-01-01", roundDown100: false, rules: [{ id: 'neu', label: 'Tata Neu (1.5%)', rate: 0.015, cap: 999999999 }, { id: 'other', label: 'Other (1%)', rate: 0.01, cap: 999999999 }, { id: 'upi', label: 'UPI (0.5%)', rate: 0.005, cap: 500 }] },
        'coral': { name: "ICICI Coral", color: "#ef4444", theme: "theme-icici", billingDay: 1, waiverLimit: 150000, anniversary: "2024-01-01", roundDown100: false, rules: [{ id: 'gen', label: 'Spends (0.5%)', rate: 0.005, cap: 999999999 }] },
        'simply': { name: "Simply Save", color: "#10b981", theme: "theme-generic", billingDay: 1, waiverLimit: 100000, anniversary: "2024-01-01", roundDown100: false, rules: [{ id: 'dining', label: 'Dining (1.6%)', rate: 0.0166, cap: 999999999 }, { id: 'other', label: 'Other (0.16%)', rate: 0.0016, cap: 999999999 }] },
        'sbi_phonepe': { name: "SBI PhonePe Black", color: "#6739b7", theme: "theme-phonepe", billingDay: 5, waiverLimit: 0, anniversary: "2024-01-01", roundDown100: true, minTxn: 100, rules: [ { id: 'phonepe_app', label: 'PhonePe App (10%)', rate: 0.10, cap: 2000 }, { id: 'online', label: 'Online (5%)', rate: 0.05, cap: 2000 }, { id: 'scanpay', label: 'Scan & Pay (1%)', rate: 0.01, cap: 999999999 }, { id: 'utility_other', label: 'Utility Non-App (1%)', rate: 0.01, cap: 500 }, { id: 'other', label: 'Other (1%)', rate: 0.01, cap: 2000 } ] }
    };

    // --- STATE ---
    let CARDS = JSON.parse(JSON.stringify(DEFAULT_CARDS));
    let transactions = [], presets = [], cardSettings = {};
    let visibleCards = Object.keys(CARDS); // Default: All visible
    let activeCardId = 'airtel';
    let userData = null;

    // --- AUTH & SYNC ---
    auth.onAuthStateChanged(user => {
        const loader = document.getElementById('authLoader');
        const buttons = document.getElementById('authButtons');
        const screen = document.getElementById('loginScreen');
        
        if(user) {
            currentUser = user;
            screen.classList.add('hidden'); // Smooth fade out
            loadUserData();
        } else {
            currentUser = null;
            document.getElementById('authLoader').style.display = 'none';
            document.getElementById('authButtons').style.display = 'block';
            // Keep login screen visible
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => alert("Login Failed: " + err.message));
    }

    function continueAsGuest() {
        document.getElementById('loginScreen').classList.add('hidden');
        loadLocalData();
    }

    function logout() {
        auth.signOut().then(() => window.location.reload());
    }

    // --- DATA LOADING ---
    function loadLocalData() {
        try { transactions = JSON.parse(localStorage.getItem('cm_trans')) || []; } catch(e) { transactions = []; }
        try { presets = JSON.parse(localStorage.getItem('cm_presets')) || [{name:"Zomato", amt:"", cat:"eats", cardId:"airtel"}]; } catch(e) { presets = []; }
        try { cardSettings = JSON.parse(localStorage.getItem('cm_settings')) || {}; } catch(e) { cardSettings = {}; }
        try { visibleCards = JSON.parse(localStorage.getItem('cm_visible')) || Object.keys(CARDS); } catch(e) { visibleCards = Object.keys(CARDS); }
        
        applySettings();
        initSlider();
        refreshAll();
    }

    async function loadUserData() {
        const docRef = db.collection('users').doc(currentUser.uid);
        const doc = await docRef.get();
        
        if (doc.exists) {
            const data = doc.data();
            transactions = data.trans || [];
            presets = data.presets || [];
            cardSettings = data.settings || {};
            visibleCards = data.visibleCards || Object.keys(CARDS);
            userData = { name: data.name, mobile: data.mobile };
            
            if(userData.name) document.getElementById('sidebarUser').innerText = userData.name;
            saveToLocal(); // Sync cloud to local
        } else {
            // First time user -> Prompt Setup
            userData = { name: currentUser.displayName, mobile: null };
            document.getElementById('setupName').value = userData.name;
            document.getElementById('userModal').style.display = 'flex';
        }
        
        document.getElementById('loginScreen').classList.add('hidden');
        applySettings();
        initSlider();
        refreshAll();
    }

    async function saveUserDetails() {
        const name = document.getElementById('setupName').value.trim();
        const mobile = document.getElementById('setupMobile').value.trim();
        if(!name || mobile.length !== 10) return alert("Invalid Details");

        const snapshot = await db.collection('users').where('mobile', '==', mobile).get();
        let isTaken = false;
        snapshot.forEach(doc => { if(doc.id !== currentUser.uid) isTaken = true; });
        if(isTaken) return alert("Mobile already registered!");

        userData = { name, mobile };
        document.getElementById('sidebarUser').innerText = name;
        await db.collection('users').doc(currentUser.uid).set({
            name, mobile, trans: transactions, presets: presets, settings: cardSettings, visibleCards
        }, { merge: true });
        
        document.getElementById('userModal').style.display = 'none';
        showToast("Setup Complete!");
    }

    async function saveData() {
        saveToLocal();
        if(currentUser) {
            await db.collection('users').doc(currentUser.uid).update({
                trans: transactions, presets: presets, settings: cardSettings, visibleCards
            });
        }
    }

    function saveToLocal() {
        localStorage.setItem('cm_trans', JSON.stringify(transactions));
        localStorage.setItem('cm_presets', JSON.stringify(presets));
        localStorage.setItem('cm_settings', JSON.stringify(cardSettings));
        localStorage.setItem('cm_visible', JSON.stringify(visibleCards));
    }

    function applySettings() {
        Object.keys(cardSettings).forEach(id => {
            if(CARDS[id]) {
                CARDS[id].billingDay = parseInt(cardSettings[id].day) || CARDS[id].billingDay;
                CARDS[id].anniversary = cardSettings[id].anniv || CARDS[id].anniversary;
            }
        });
    }

    // --- INIT UI ---
    document.getElementById('tDate').valueAsDate = new Date();

    // --- CORE LOGIC (SLIDER & VISIBILITY) ---
    function initSlider() {
        const swiper = document.getElementById('cardSwiper');
        swiper.innerHTML = '';
        
        if (!visibleCards || visibleCards.length === 0) visibleCards = Object.keys(CARDS);

        visibleCards.forEach(key => {
            const c = CARDS[key];
            if(c) {
                swiper.innerHTML += `
                <div class="credit-card ${c.theme} visible" id="card-${key}" onclick="selectCard('${key}', true)">
                    <div class="card-bg-shine"></div>
                    <div class="card-top"><div class="chip"></div><div class="card-logo">${c.name}</div></div>
                    <div class="card-val"><span>Cashback</span><h2 id="val-${key}">‚Çπ0</h2></div>
                </div>`;
            }
        });

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(e => { if(e.isIntersecting) selectCard(e.target.id.replace('card-', ''), false); });
        }, { root: swiper, threshold: 0.6 });
        document.querySelectorAll('.credit-card').forEach(c => observer.observe(c));
        
        // Select first visible card if none active
        if(visibleCards.length > 0 && !visibleCards.includes(activeCardId)) activeCardId = visibleCards[0];
        
        // Wait for DOM update then trigger selection
        setTimeout(() => selectCard(activeCardId, true), 200);
    }

    function selectCard(cId, scroll) {
        if(activeCardId === cId && !scroll) return;
        activeCardId = cId;
        document.querySelectorAll('.credit-card').forEach(el => el.classList.remove('active-card'));
        const card = document.getElementById(`card-${cId}`);
        if(card) {
            card.classList.add('active-card');
            document.documentElement.style.setProperty('--accent', CARDS[cId].color);
            document.querySelector('.sidebar-header').style.background = CARDS[cId].color;
            if(scroll) card.scrollIntoView({behavior: 'smooth', block: 'center', inline: 'center'});
        }
        updateHeaderCycle();
        renderContent();
    }

    function updateHeaderCycle() {
        const c = CARDS[activeCardId];
        const cycle = getCycleDates(c.billingDay);
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        document.getElementById('headerCycle').innerText = `${months[cycle.start.getMonth()]} - ${months[cycle.end.getMonth()]}`;
    }

    function refreshAll() {
        let grand = 0;
        visibleCards.forEach(cId => {
            const s = getStats(cId);
            grand += s.total;
            const el = document.getElementById(`val-${cId}`);
            if(el) el.innerText = `‚Çπ${s.total.toFixed(0)}`;
        });
        document.getElementById('grandTotal').innerText = `‚Çπ${grand.toFixed(0)}`;
        updateHeaderCycle();
        renderContent();
    }

    function getStats(cId, startDate = null, endDate = null) {
        const list = transactions.filter(t => t.cardId === cId);
        let total = 0, catTotals = {}, sbiGlobal = 0, totalSpend = 0;
        let start = startDate, end = endDate;
        if(!start) { const c = getCycleDates(CARDS[cId].billingDay); start = c.start; end = c.end; }

        const filteredList = list.filter(t => { const d = new Date(t.date); return d >= start && d < end; });
        const isRoundDown = CARDS[cId].roundDown100 || false;
        const minTxn = CARDS[cId].minTxn || 0;

        filteredList.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            totalSpend += t.amount;
            const rule = CARDS[cId].rules.find(r => r.id === t.cat) || CARDS[cId].rules[0];
            
            let calcAmount = t.amount;
            if(calcAmount < minTxn) calcAmount = 0;
            else if (isRoundDown) calcAmount = Math.floor(calcAmount / 100) * 100;

            let earned = 0, pot = calcAmount * rule.rate;

            if(cId === 'sbi' && rule.id === 'online') {
                let rem = 5000 - sbiGlobal;
                earned = Math.max(0, Math.min(pot, rem));
                sbiGlobal += earned;
            } 
            // Fix: Compare with very large number instead of Infinity for JSON safety
            else if(rule.cap < 999999) { 
                let cur = catTotals[rule.id] || 0;
                let rem = rule.cap - cur;
                earned = Math.max(0, Math.min(pot, rem));
            } else { earned = pot; }
            
            catTotals[rule.id] = (catTotals[rule.id] || 0) + earned;
            total += earned;
            t.cb = earned;
        });

        const annivDate = new Date(CARDS[cId].anniversary);
        const today = new Date();
        let waiverStart = new Date(today.getFullYear(), annivDate.getMonth(), annivDate.getDate());
        if(today < waiverStart) waiverStart.setFullYear(today.getFullYear() - 1);
        const annualList = list.filter(t => new Date(t.date) >= waiverStart);
        const annualSpend = annualList.reduce((sum, t) => sum + t.amount, 0);

        return { total, catTotals, list: filteredList.reverse(), totalSpend, annualSpend };
    }

    function getCycleDates(startDay) {
        const now = new Date();
        const d = now.getDate();
        let sMonth = d >= startDay ? now.getMonth() : now.getMonth() - 1;
        let sYear = now.getFullYear();
        if (sMonth < 0) { sMonth = 11; sYear--; }
        return { start: new Date(sYear, sMonth, startDay), end: new Date(sYear, sMonth + 1, startDay) };
    }

    function renderContent() {
        const c = CARDS[activeCardId];
        const s = getStats(activeCardId);
        const lDiv = document.getElementById('limit-container');
        lDiv.innerHTML = '';
        c.rules.forEach(r => {
            const val = s.catTotals[r.id] || 0;
            // Use 999999 check for "Unlimited" logic
            let pct = r.cap > 999999 ? 100 : Math.min((val/r.cap)*100, 100);
            let txt = r.cap > 999999 ? `‚Çπ${val.toFixed(0)}` : `‚Çπ${val.toFixed(0)} / ‚Çπ${r.cap}`;
            lDiv.innerHTML += `<div class="bar-item"><div class="bar-head"><span>${r.label}</span><span>${txt}</span></div><div class="track"><div class="fill" style="width:${pct}%"></div></div></div>`;
        });
        const hDiv = document.getElementById('trans-container');
        hDiv.innerHTML = '';
        if(s.list.length === 0) hDiv.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.4">No transactions</div>';
        s.list.forEach(t => {
            const rule = c.rules.find(r=>r.id===t.cat)||{label:t.cat};
            hDiv.innerHTML += `<div class="trans-item"><div class="t-left"><h4>${t.desc}</h4><div class="t-cat">${rule.label} ‚Ä¢ ${new Date(t.date).toLocaleDateString()}</div></div><div class="t-right"><div>‚Çπ${t.amount}</div><div class="t-cb">+‚Çπ${t.cb.toFixed(2)}</div><div class="del-btn" onclick="delTrans(${t.id})">Delete</div></div></div>`;
        });
        if(c.waiverLimit > 0) {
            const pct = Math.min((s.annualSpend / c.waiverLimit)*100, 100);
            document.getElementById('waiverStatus').innerText = `‚Çπ${(s.annualSpend/1000).toFixed(1)}k / ‚Çπ${(c.waiverLimit/1000).toFixed(0)}k`;
            document.getElementById('waiverFill').style.width = `${pct}%`;
            document.getElementById('waiverMsg').innerText = pct >= 100 ? "üéâ Fee Waived!" : `Spend ‚Çπ${(c.waiverLimit - s.annualSpend).toLocaleString()} more`;
        } else {
             document.getElementById('waiverStatus').innerText = "Lifetime Free";
             document.getElementById('waiverFill').style.width = "100%";
             document.getElementById('waiverMsg').innerText = "No annual fee";
        }
    }

    // --- ACTIONS & UTILS ---
    function checkAuthAndOpen() {
        if (!currentUser) {
             // If Guest tries to add transaction, show Login Prompt
             document.getElementById('loginScreen').classList.remove('hidden');
             alert("Please login to add transactions!");
        } else {
             openAddModal();
        }
    }

    function openAddModal() {
        document.getElementById('addModal').classList.add('active');
        const s = document.getElementById('tCategory'); s.innerHTML = '';
        CARDS[activeCardId].rules.forEach(r => s.innerHTML += `<option value="${r.id}">${r.label}</option>`);
        renderPresets();
        if(!document.getElementById('tDate').value) document.getElementById('tDate').valueAsDate = new Date();
    }
    function renderPresets() {
        const p = document.getElementById('presetsArea'); p.innerHTML = '';
        presets.forEach((x, i) => {
            if(x.cardId === activeCardId || !x.cardId) { 
               p.innerHTML += `<div class="preset-chip" onclick="loadPreset(${i})">${x.name}</div>`;
            }
        });
    }
    function saveTrans() {
        const amt = parseFloat(document.getElementById('tAmount').value);
        if(!amt) return showToast("Enter Amount");
        transactions.push({ id: Date.now(), cardId: activeCardId, cat: document.getElementById('tCategory').value, desc: document.getElementById('tDesc').value || 'Spend', amount: amt, date: document.getElementById('tDate').value });
        saveData();
        document.getElementById('addModal').classList.remove('active');
        document.getElementById('tAmount').value = '';
        refreshAll(); showToast("Added!");
    }
    function savePreset() {
        const name = document.getElementById('tDesc').value;
        if(!name) return showToast("Enter Name");
        presets.push({ name, amt: document.getElementById('tAmount').value, cat: document.getElementById('tCategory').value, cardId: activeCardId });
        saveData();
        renderPresets();
    }
    function loadPreset(i) {
        const x = presets[i];
        document.getElementById('tDesc').value = x.name;
        if(x.amt) document.getElementById('tAmount').value = x.amt;
        const sel = document.getElementById('tCategory');
        for(let k=0;k<sel.options.length;k++) if(sel.options[k].value === x.cat) sel.selectedIndex = k;
    }
    function delTrans(id) {
        if(confirm("Delete?")) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            refreshAll();
        }
    }
    function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
    
    // --- MANAGE CARDS (NEW) ---
    function openManageCards() {
        toggleMenu();
        document.getElementById('manageCardsModal').classList.add('active');
        const list = document.getElementById('manageCardsList');
        list.innerHTML = '';
        Object.keys(CARDS).forEach(key => {
            const isChecked = visibleCards.includes(key) ? 'checked' : '';
            list.innerHTML += `
                <div class="card-option">
                    <label><input type="checkbox" value="${key}" ${isChecked}> ${CARDS[key].name}</label>
                </div>`;
        });
    }

    function saveVisibleCards() {
        const checkboxes = document.querySelectorAll('#manageCardsList input[type="checkbox"]');
        visibleCards = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
        saveData();
        document.getElementById('manageCardsModal').classList.remove('active');
        initSlider();
        refreshAll();
    }

    // --- SETTINGS & HISTORY ---
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function openCycleSettings() { toggleMenu(); document.getElementById('cycleModal').classList.add('active'); const s = document.getElementById('cCardSelect'); s.innerHTML = ''; Object.keys(CARDS).forEach(k => s.innerHTML += `<option value="${k}">${CARDS[k].name}</option>`); s.value = activeCardId; loadCardSettings(); }
    function loadCardSettings() { const id = document.getElementById('cCardSelect').value; document.getElementById('cStartDay').value = CARDS[id].billingDay; document.getElementById('cAnniversary').value = CARDS[id].anniversary; }
    function saveCardSettings() { const id = document.getElementById('cCardSelect').value; const d = parseInt(document.getElementById('cStartDay').value); const a = document.getElementById('cAnniversary').value; if(!d || !a) return showToast("Invalid Input"); CARDS[id].billingDay = d; CARDS[id].anniversary = a; cardSettings[id] = {day:d, anniv:a}; saveData(); document.getElementById('cycleModal').classList.remove('active'); refreshAll(); showToast("Saved!"); }
    
    function openHistoryModal() { toggleMenu(); document.getElementById('historyModal').classList.add('active'); const s = document.getElementById('hCardSelect'); s.innerHTML=''; Object.keys(CARDS).forEach(k=>s.innerHTML+=`<option value="${k}">${CARDS[k].name}</option>`); s.value = activeCardId; updateHistoryCycles(); }
    function updateHistoryCycles() {
        const id = document.getElementById('hCardSelect').value; const day = CARDS[id].billingDay; const sel = document.getElementById('hCycleSelect'); sel.innerHTML = '';
        for(let i=0; i<12; i++) {
            let d = new Date(); d.setDate(1); d.setMonth(d.getMonth()-i);
            let s = new Date(d.getFullYear(), d.getMonth(), day); let e = new Date(d.getFullYear(), d.getMonth()+1, day);
            if(s > new Date()) { s.setMonth(s.getMonth()-1); e.setMonth(e.getMonth()-1); }
            let opt = document.createElement('option'); opt.value = JSON.stringify({s:s.toISOString(), e:e.toISOString()}); opt.text = `${s.toLocaleDateString('en-US', {month:'short', day:'numeric'})} - ${e.toLocaleDateString('en-US', {month:'short', day:'numeric'})}`; sel.appendChild(opt);
        } renderHistoryList();
    }
    function renderHistoryList() {
        const id = document.getElementById('hCardSelect').value; const range = JSON.parse(document.getElementById('hCycleSelect').value);
        const stats = getStats(id, new Date(range.s), new Date(range.e));
        document.getElementById('hTotalSpend').innerText = `‚Çπ${stats.totalSpend.toFixed(0)}`;
        document.getElementById('hTotalCb').innerText = `‚Çπ${stats.total.toFixed(2)}`;
        const div = document.getElementById('hListContainer'); div.innerHTML = '';
        if(stats.list.length === 0) div.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">No data</div>';
        stats.list.forEach(t => {
            const rule = CARDS[id].rules.find(r=>r.id===t.cat)||{label:t.cat};
            div.innerHTML += `<div class="trans-item"><div class="t-left"><h4>${t.desc}</h4><div class="t-cat">${rule.label} ‚Ä¢ ${new Date(t.date).toLocaleDateString()}</div></div><div class="t-right"><div>‚Çπ${t.amount}</div><div class="t-cb">+‚Çπ${t.cb.toFixed(2)}</div></div></div>`;
        });
    }

    // --- DATA SETTINGS ---
    function openSettings() { toggleMenu(); document.getElementById('settingsModal').classList.add('active'); }
    function exportJSON() {
        const data = { trans: transactions, presets: presets, settings: cardSettings, user: userData, visibleCards };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
        a.download = `CardMaster_Backup.json`;
        a.click();
    }
    function importJSON(e) {
        const r = new FileReader();
        r.onload = async (res) => {
            try {
                const data = JSON.parse(res.target.result);
                if(data.trans) transactions = data.trans;
                if(data.presets) presets = data.presets;
                if(data.settings) cardSettings = data.settings;
                if(data.visibleCards) visibleCards = data.visibleCards;
                await saveData();
                alert("Data Restored!"); location.reload();
            } catch(err) { alert("Invalid File"); }
        };
        r.readAsText(e.files[0]);
    }
    function clearAll() {
        if(confirm("RESET ALL DATA? This cannot be undone.")) {
            localStorage.clear();
            if(currentUser) {
                db.collection('users').doc(currentUser.uid).delete().then(() => location.reload());
            } else {
                location.reload();
            }
        }
    }
</script>
</body>
</html>
